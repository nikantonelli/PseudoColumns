<!DOCTYPE html>
<html>
<head>
    <title>PseudoColumns</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",id:"columnsApp",items:[],config:{defaultSettings:{colStrings:Ext.JSON.encode([{text:"Title One"},{text:"Title Two"},{text:"Title Three"}])}},getSettingsFields:function(){return Settings.getFields(this.getContext())},launch:function(){var app=this;this.add({xtype:"rallyportfolioitemtypecombobox",stateful:!0,stateId:this.getStateId(),id:"piType",listeners:{ready:function(){app._onLoad(app,this.rawValue)},change:function(){app._onLoad(app,this.rawValue)},scope:app}})},_addGrid:function(){var grid=this.down("rallygrid");grid&&grid.destroy(),this.grid=Ext.create("Rally.ui.grid.Grid",this._getGridConfig(this.getSetting("allowedTextFields"))),this.insert(1,this.grid)},_getGridConfig:function(field){var gridConfig={xtype:"rallygrid",store:this.store,enableBulkEdit:!0,enableColumnResize:!0,bulkEditConfig:{showEdit:!1,showTag:!1,showParent:!1,showRemove:!1,showMilestones:!1},context:this.getContext(),plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2})],columnCfgs:[{text:"ID",dataIndex:"FormattedID",width:75},"Name","Description",{text:"Owner",dataIndex:"Owner",width:75},"Project",{text:"Business Outcome",dataIndex:"Parent"},{text:"% Done",dataIndex:"PercentDoneByStoryPlanEstimate",width:100},{text:"Accepted Stories",dataIndex:"AcceptedLeafStoryCount",width:75,align:"center"},{text:"Total Story Count",dataIndex:"LeafStoryCount",width:75,align:"center"},{text:"Accepted Story Estimates",dataIndex:"AcceptedLeafStoryPlanEstimateTotal",width:75,align:"center"},{text:"Total Story Estimate",dataIndex:"LeafStoryPlanEstimateTotal",width:75,align:"center"},{text:"Milestones",dataIndex:"Milestones",readOnly:!0},"LastUpdateDate"].concat(_.map(Ext.JSON.decode(this.getSetting("colStrings")),function(colstring){var retval={text:colstring.text,dataIndex:field,editor:{xtype:"apprichtexteditor"},renderer:function(value,metaData,record,rowIdx,colIdx,store){return retval=this._findSubText(value,colIdx)},columnHeaderConfig:{headerTpl:colstring||"Invalid App Setting"}};return retval})),_findSubText:function(value,colIdx){var startString=this.columns[colIdx-1].text,endString=this.columns.length>colIdx?this.columns[colIdx].text:null;return this._parseWTF(value,startString,endString)},_parseWTF:function(value,strB,strE){var startPoint=value.indexOf(strB);if(0>startPoint)return"";var gotDiv=!1,midDiv=!1;startPoint>4&&("<div>"===value.slice(startPoint-5,startPoint)&&(gotDiv=!0,startPoint-=5),"</div>"===value.slice(startPoint+strB.length+5,startPoint+strB.length+11)&&(midDiv=!0));var endPoint=value.indexOf(strE);endPoint>0?"<div>"===value.slice(endPoint-5,endPoint)&&(endPoint-=5):endPoint=value.length;for(var finalString=value.slice(startPoint,endPoint),uselessDiv="<div><br /></div>";finalString.slice(finalString.length-uselessDiv.length,finalString.length)==uselessDiv;)finalString=finalString.slice(0,finalString.length-uselessDiv.length);for(finalString=gotDiv?midDiv?finalString.slice(strB.length+11,finalString.length):finalString.slice(strB.length+5,finalString.length-6):finalString.slice(strB.length,finalString.length);finalString.slice(0,uselessDiv.length)==uselessDiv;)finalString=finalString.slice(uselessDiv.length,finalString.length);return finalString}};return gridConfig},_onLoad:function(app,value){var modelType="portfolioitem/"+this.down("rallyportfolioitemtypecombobox").rawValue,filters=[],timeboxScope=app.getContext().getTimeboxScope();timeboxScope&&filters.push(timeboxScope.getQueryFilter());var queryString=app.getSetting("query");if(queryString){var filterObj=Rally.data.wsapi.Filter.fromQueryString(queryString);filterObj.itemId=""+filterObj,filters.push(filterObj)}var itemStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:[modelType],filters:filters,autoLoad:!0,fetch:["FormattedID","Name","Owner","Notes","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","AcceptedLeafStoryCount","LeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal","LastUpdateDate","Description","Project","Parent","PlannedStartDate","PlannedEndDate","ActualStartDate","ActualEndDate","Milestones"],hydrate:["Milestones"],listeners:{load:function(store,data,success){this.store=store,this._addGrid()},scope:app}});app.exporter=Ext.create("GridExporter");var rallybutton=this.down("rallybutton");rallybutton&&rallybutton.destroy(),app.add({id:"exportButton",margin:"5 5 5 5",xtype:"rallybutton",text:"Export",handler:function(){var saveDialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,width:300,title:"Export all records",items:[{xtype:"rallybutton",text:"CSV",handler:function(){app.exporter.exportCSV(app.grid),saveDialog.destroy()}}]})}})}}),Ext.define("Rally.ui.bulk.RecordMenuFix",{override:"Rally.ui.menu.bulk.RecordMenu",_getMenuItems:function(){var records=this.getRecords(),items=this.callParent(arguments);return items.push({xtype:"resetBulkField",id:"resetBulkField"}),_.each(items,function(item){Ext.apply(item,{records:records,store:this.store,onBeforeAction:this.onBeforeAction,onActionComplete:this.onActionComplete,context:this.getContext()})},this),items}}),Ext.define("resetBulkField",{extend:Rally.ui.menu.bulk.MenuItem,alias:"widget.resetBulkField",config:{text:"Reset Field",handler:function(arg1,arg2,arg3){var fields=_.map(Ext.JSON.decode(Ext.getCmp("columnsApp").getSetting("colStrings")),function(value){return value.text}),theString="";_.each(fields,function(field){theString+="<div>"+field+"</div><div><br /></div>"}),_.each(this.records,function(record){record.set(Ext.getCmp("columnsApp").getSetting("allowedTextFields"),theString),record.save()})}}}),Ext.define("AppRichTextEditor",{extend:Ext.Component,alias:"widget.apprichtexteditor",config:{hideMode:"offsets",listeners:{}},constructor:function(config,arg2,arg3,arg4){this.mergeConfig(config),this.callParent([this.config])},initComponent:function(arg1,arg2,arg3,arg4){this.callParent(arguments),this.addEvents("beforestartedit")},startEdit:function(el,value,context){var me=this,field=me.field;me.completeEdit(),me.boundEl=Ext.get(el),value=Ext.isDefined(value)?value:Ext.String.trim(me.boundEl.dom.innerText||me.boundEl.dom.innerHTML),me.rendered||(me.ownerCt&&(me.parentEl=me.ownerCt.el,me.parentEl.position()),me.render(me.parentEl||document.doby)),me.fireEvent("beforestartedit",me,me.boundEl,value)!==!1&&(me.startValue=value,me.show(),me.editing=!0)}});
                Ext.define("StringsField",{extend:"Ext.form.field.Base",alias:"widget.stringsfield",requires:["Rally.ui.Button"],fieldSubTpl:'<div id="{id}"></div>',cls:"colStrings",config:{value:void 0},onDestroy:function(){this._stringsContainer&&(this._stringsContainer.destroy(),delete this._stringsContainer),this.callParent(arguments)},onRender:function(){this.callParent(arguments),this._stringsContainer=Ext.create("Ext.Container",{renderTo:this.inputEl,cls:"strings-container",items:this._buildRows()})},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(_.map(Ext.ComponentQuery.query("container",this._stringsContainer),function(row){var labelTextBox=Ext.ComponentQuery.query("rallytextfield",row)[0];return{text:labelTextBox.getValue()}})),data},_buildRows:function(){return[{xtype:"component",margin:"0 0 5px 0",html:'<span class="label-header">Title</span>'}].concat(_.map(Ext.JSON.decode(this._value),function(value){return this._buildRow(value)},this))},_buildRow:function(value){return{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",border:!1,frame:!1,cls:"row-btn plus",disabled:!1,itemId:"plusButton",iconCls:"icon-plus",listeners:{click:this._addRow,scope:this}},{xtype:"rallybutton",border:!1,cls:"row-btn minus",frame:!1,iconCls:"icon-minus",itemId:"minusButton",listeners:{click:this._removeRow,scope:this}},{xtype:"rallytextfield",width:500,value:value&&value.text}]}},_addRow:function(button){var container=button.up(),stringsContainer=container.up(),index=stringsContainer.items.indexOf(container);stringsContainer.insert(index+1,this._buildRow());var appSettings=this.up("rallyappsettings");appSettings.fireEvent("appsettingsready",appSettings)},_removeRow:function(button){button.up().destroy();var appSettings=this.up("rallyappsettings");appSettings.fireEvent("appsettingsready",appSettings)},setValue:function(value){this.callParent(arguments),this._value=value}});
                Ext.define("Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.NumberField","Rally.data.wsapi.Filter","StringsField"],getFields:function(context){var blackListedFields=["DisplayColor","Name","DragAndDropRank","InvestmentCategory"];return[{name:"allowedTextFields",xtype:"rallyfieldcombobox",model:"portfolioitem/"+Ext.getCmp("piType").rawValue,fieldLabel:"Text Field",readyEvent:"ready",_isNotHidden:function(field){var retval="string"==field.type.type&&!(field.hidden||_.contains(blackListedFields,field.name)||field.readOnly);return retval}},{name:"colStrings",xtype:"stringsfield",fieldLabel:"Columns"},{type:"query"}]}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d",inheritableStatics:{XmlFileHeader:'<?xml version="1.0"?>',XmlFileExtension:".xml.txt"},_downloadFiles:function(files){if(files.length){var data=files.pop(),format=files.pop(),file=files.pop(),href="<a href='"+format+","+encodeURIComponent(data)+"' download='"+file+"'></a>",ml=Ext.DomHelper.insertAfter(window.document.getElementById("exportButton"),href);ml.click(),this._downloadFiles(files)}},exportCSV:function(grid){var data=this._getCSV(grid,!1);data=data.replace(/\'/g,""),this._downloadFiles(["export.csv","data:text/csv;charset=utf8",data])},_escapeForCSV:function(string){return string=""+string,string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData,record,col,index){var text;return null===fieldData||void 0===fieldData?text="":fieldData._refObjectName&&!fieldData.getMonth?text=fieldData._refObjectName:fieldData instanceof Date?text=Ext.Date.format(fieldData,this.dateFormat):"string"==typeof fieldData?(text=fieldData.replace(/<[^>]*>/g," "),text=text.replace(/\’/g,"'"),text=text.replace(/&nbsp\;/g," ")):"Milestone"==fieldData._type?(text="",_.each(fieldData._tagsNameArray,function(value){0!==text.length&&(text+=" / "),text+=value.Name})):text=fieldData,text},_getFieldTextAndEscape:function(fieldData,record,col,index){var string=this._getFieldText(fieldData,record,col,index);return this._escapeForCSV(string)},fixedColumnCount:function(columns){var cols=_.filter(columns,function(c){return void 0!==c&&null!==c&&c.locked===!0});return cols.length},_stripDivs:function(text){var retval=text.replace("<div>","");return retval=retval.replace("</div>",""),retval=retval.replace("<br />","")},_getCSV:function(grid){var cols=grid.columns,store=grid.store,hdrData="",rowData="",valid=!0,that=this;return Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var colLabel=col&&col.dataIndex;colLabel&&colLabel.replace(/<br\/?>/,"")&&(hdrData+=col.editor&&"apprichtexteditor"===col.editor.xtype?that._getFieldTextAndEscape(col.text)+",":that._getFieldTextAndEscape(colLabel)+",")}}),hdrData+="\n",_.each(store.data.items,function(record,i){Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var fieldName=col&&col.dataIndex;if(fieldName){var text=record.get(fieldName);if(col.editor&&"apprichtexteditor"===col.editor.xtype){var rg=this.up("rallygrid"),rt=rg._findSubText(text,index+1);rt=that._stripDivs(rt),rowData+=that._getFieldTextAndEscape(rt)+","}else rowData+=that._getFieldTextAndEscape(text,record,col,index)+","}}}),rowData+="\n"}),rowData.length>0?hdrData+rowData:null}});

            Rally.launchApp('CustomApp', {
                name:"PseudoColumns",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .strings .x-field-label-cell{vertical-align:top}.strings .label-header{margin-left:60px;font-family:NotoSansBold;font-size:12px}.strings .strings-container{margin-top:5px}.row-btn{background-color:transparent;font-size:14px;height:26px;width:28px;float:left;padding:2px 0 0 0}.row-btn .btn-button{border:0 !important}.row-btn.minus{color:#666666}.row-btn.plus{color:#00A9E0}.row-btn.plus:hover{color:#29beff}.row-btn.plus.item-disabled,.row-btn.plus.item-disabled:hover{cursor:default}.row-btn.plus.item-disabled span,.row-btn.plus.item-disabled:hover span{color:#666666}
    </style>
</head>
<body>
</body>
</html>
